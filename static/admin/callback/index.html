<!doctype html>
<html>
<head><title>GitHub Auth Callback</title></head>
<body>
<script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");



    if (!code) {
        document.body.innerText = "Missing GitHub code.";
    } else {
        fetch("https://kp4cy6n8jj.execute-api.eu-west-1.amazonaws.com/production/api/auth", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
        })
            .then((res) => res.json())
            .then((data) => {

                console.log("OAuth code:", code);
                console.log("Auth result:", data);
                console.log("Window opener:", window.opener);

                if (data.token) {
                    window.opener.postMessage(
                        {
                            data: {
                                token: data.token,
                                user: data.user,
                            },
                            source: "decap-cms",
                        },
                        window.location.origin
                    );
                    // setTimeout(() => {
                    //     window.close();
                    // }, 10000); // Wait 10 seconds before closing (debug)
                } else {
                    document.body.innerText = "Error: " + JSON.stringify(data);
                }
            });
    }
</script>
</body>
</html>